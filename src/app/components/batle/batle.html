<button class="open-btn" (click)="endBatle()">
    End batle
</button>
<button class="open-btn" (click)="finishAction()">
    End turn
</button>
<button class="open-btn" (click)="openStats()">
    {{ isStats() ? 'Close stats' : 'Show stats' }}
</button>

@if (socketService.battleEndReason()) {
    <div class="battle-end-overlay">
        <div class="end-modal">
            <h2>You won!</h2>
            <p>Enemy run out a field.</p>
            <button (click)="endBatle()">Return to lobby</button>
        </div>
    </div>
}

<div class="battle-chat-container">
    <div class="chat-messages" #battleChatScroll>
        @for (msg of socketService.battleMessages(); track $index) {
            <div class="msg-item" [class.my-msg]="msg.user === socketService.currentUser()">
                <div class="msg-header">
                    <span class="msg-user">{{ msg.user }}</span>
                    <span class="msg-time">{{ msg.time }}</span>
                </div>
                <div class="msg-text">{{ msg.text }}</div>
            </div>
        }
    </div>

    <div class="chat-input-area">
        <input 
            type="text" 
            [(ngModel)]="chatMessage" 
            (keyup.enter)="sendBattleMsg()"
            placeholder="Write message...">
        <button (click)="sendBattleMsg()">ðŸ¡ª</button>
    </div>
</div>

<div class="game-wrapper">
    <div class="batle-container">
        <div class="battle-grid">
            @for (row of batleMap(); track $index; let rowX = $index) {
                @for (tile of row; track $index; let rowY = $index) {
                    <div class="tile" 
                        [class]="tile.type"
                        [class.processing]="tile.isProcessing" 
                        [class.atack]="tile.isAtack" 
                        (click)="onTileClick({x:rowX, y:rowY})"
                        (keydown)="onTileClick({x:rowX, y:rowY})">
                    </div>
                }
            }
            @for (unit of unitsInBattle(); track unit.id) {
                <div class="unit"
                    [style.transform]="getUnitStyle(unit)"
                    [style.transition]="'transform 1s'"
                    [class.enemy-unit]="unit.owner !== socketService.currentUser()"
                    [class.active-unit-on-map]="activeUnit()?.id === unit.id">
                    <span class="unit-img">{{ unit.image }}</span>

                    @if (activeUnit()?.id === unit.id) {
                        @if (activeUnit()?.race === 'human') {
                            <div class="spells-container">
                                @for (spell of unit.spells; track spell.name) {
                                    <div class="spell"
                                        [class]="'type-' + spell.type"
                                        (click)="spellActivate(spell)"
                                        (keydown)="spellActivate(spell)">
                                        <img [src]="spell.icon" [alt]="spell.name" />
                                        <div class="spell-tooltip">
                                            <div>{{ spell.name }}</div>
                                            <div>Damage: x{{ spell.damageFactor }}</div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                            
                        <div class="unit-aura"></div>
                    }

                    @if (isStats()) {
                        <div class="unit-stats" [class.visible]="selectedUnitId === unit.id">
                            <div class="stats-header">{{ unit.race }} {{ unit.type }}</div>
                            <div class="stats-row">HP: <span>{{ unit.currentHealth }}/{{ unit.health }}</span></div>
                            <div class="stats-row">DMG: <span>{{ unit.damage }}</span></div>
                            <div class="stats-row">SPD: <span>{{ unit.speed }}</span></div>
                            <div class="stats-row">XP: <span>{{ unit.xp }}/{{ unit.xpForLvl }}</span></div>
                            <div class="stats-row">LVL: <span>{{ unit.level }}</span></div>
                        </div>
                    }
                    
                    <div class="hp-bar">
                        <div class="hp-fill" [style.width.%]="(unit.currentHealth / unit.health) * 100"></div>
                    </div>
                </div>
            }
        </div>
    </div>
        
    <div class="turn-queue">
        @for (unit of turnQueue().slice(0, 10); track unit.id; let i = $index) {
            <div class="queue-item" 
                [class.my-queue]="unit.owner === socketService.currentUser()"
                [class.enemy-queue]="unit.owner !== socketService.currentUser()"
                [class.active-turn]="activeUnit()?.id === unit.id"
                [style.--i] color="i">
                
                <span class="queue-unit-img">{{ unit.image }}</span>
                
                <div class="queue-unit-info">
                    <span class="level">lvl {{ unit.level }}</span>
                </div>
            </div>
        }
    </div>

</div>
